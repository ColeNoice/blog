name: åŒæ­¥ç¬”è®°æ–‡ç« 

on:
  repository_dispatch:
    types: [sync-articles]
  workflow_dispatch:
    inputs:
      force_sync:
        description: å¼ºåˆ¶åŒæ­¥æ‰€æœ‰æ–‡ç« 
        required: false
        default: 'false'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºåšå®¢ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: æ£€å‡ºç¬”è®°ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/note
          token: ${{ secrets.PAT_TOKEN }}
          path: note-repo
          fetch-depth: 0

      - name: åŒæ­¥æ–‡ç« 
        run: |
          #!/bin/bash
          set -e

          # é…ç½®
          NOTE_REPO="./note-repo"
          BLOG_CONTENT_DIR="./content/posts"
          SYNCED_COUNT=0
          SKIPPED_COUNT=0

          # ç¡®ä¿åšå®¢å†…å®¹ç›®å½•å­˜åœ¨
          mkdir -p "$BLOG_CONTENT_DIR"

          echo "ğŸ” å¼€å§‹æ‰«æç¬”è®°ä»“åº“ä¸­çš„ Markdown æ–‡ä»¶..."

          # æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ’é™¤éšè—ç›®å½•ï¼‰
          while IFS= read -r -d '' file; do
            echo "æ£€æŸ¥æ–‡ä»¶: $file"

            # æå–æ–‡ä»¶çš„ frontmatter
            # è¯»å–æ–‡ä»¶ç›´åˆ°æ‰¾åˆ°ç¬¬äºŒä¸ª --- åˆ†éš”ç¬¦
            in_frontmatter=false
            frontmatter_content=""
            content_lines=""
            line_num=0

            while IFS= read -r line; do
              line_num=$((line_num + 1))

              # æ£€æµ‹ frontmatter å¼€å§‹
              if [ $line_num -eq 1 ] && [ "$line" = "---" ]; then
                in_frontmatter=true
                continue
              fi

              # æ£€æµ‹ frontmatter ç»“æŸ
              if [ "$in_frontmatter" = true ] && [ "$line" = "---" ]; then
                in_frontmatter=false
                continue
              fi

              # æ”¶é›† frontmatter å†…å®¹
              if [ "$in_frontmatter" = true ]; then
                frontmatter_content="${frontmatter_content}${line}"$'\n'
              else
                content_lines="${content_lines}${line}"$'\n'
              fi
            done < "$file"

            # æ£€æŸ¥æ˜¯å¦æœ‰ share: true
             if echo "$frontmatter_content" | grep -qE "share:[[:space:]]*true"; then
              echo "  âœ“ å‘ç°éœ€è¦åˆ†äº«çš„æ–‡ç« "

              # è®¡ç®—ç›¸å¯¹è·¯å¾„
              relative_path="${file#$NOTE_REPO/}"
              target_path="$BLOG_CONTENT_DIR/$relative_path"
              target_dir=$(dirname "$target_path")

              # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
              mkdir -p "$target_dir"

              # å¤åˆ¶æ–‡ä»¶
              cp "$file" "$target_path"

              echo "  â†’ åŒæ­¥åˆ°: $target_path"
              SYNCED_COUNT=$((SYNCED_COUNT + 1))
            else
              echo "  âŠ˜ è·³è¿‡ï¼ˆshare != trueï¼‰"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            fi

          done < <(find "$NOTE_REPO" -type f -name "*.md" ! -path "*/.*" -print0)

          echo ""
          echo "ğŸ“Š åŒæ­¥ç»Ÿè®¡:"
          echo "  â€¢ åŒæ­¥æ–‡ç« : $SYNCED_COUNT"
          echo "  â€¢ è·³è¿‡æ–‡ç« : $SKIPPED_COUNT"

      - name: æäº¤æ›´æ”¹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add content/posts/

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "ğŸ“­ æ²¡æœ‰æ–‡ç« éœ€è¦åŒæ­¥"
            exit 0
          fi

          # æäº¤æ›´æ”¹
          git commit -m "chore: ä»ç¬”è®°ä»“åº“åŒæ­¥æ–‡ç«  [skip ci]"
          git push

          echo "âœ… æ–‡ç« åŒæ­¥å®Œæˆå¹¶å·²æ¨é€"

      - name: åŒæ­¥ç»“æœé€šçŸ¥
        if: always()
        run: |
          echo "ğŸ“‹ åŒæ­¥ä»»åŠ¡å®Œæˆ"
          echo "   å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"
